<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Sensity: Deepfake Detection</title>


    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900&display=swap" rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx"
      crossorigin="anonymous"
    />
    <link href="assets/vendor/icofont/icofont.min.css" rel="stylesheet" />
    <link href="assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet" />
    <link
      href="assets/vendor/owl.carousel/assets/owl.carousel.min.css"
      rel="stylesheet"
    />
    <link href="assets/vendor/venobox/venobox.css" rel="stylesheet" />
    <link href="assets/vendor/aos/aos.css" rel="stylesheet" />

    <!-- Template Main CSS File -->
    <link href="assets/css/style.css" rel="stylesheet" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/uppload@2.3.0/dist/uppload.css"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/uppload@2.3.0/dist/themes/light.css"
      crossorigin="anonymous"
    />
    <style>
      .need-help-link {
        display: none;
      }
      .uppload-modal section {
        padding: 0;
      }
    </style>
  </head>

  <body
    data-aos-easing="ease-in-out"
    data-aos-duration="800"
    data-aos-delay="0"
  >
    <button type="button" class="mobile-nav-toggle d-lg-none">
      <i class="icofont-navigation-menu"></i>
    </button>

    <!-- ======= Header ======= -->
    <header id="header" class="fixed-top">
      <div class="container d-flex">
        <div class="logo mr-auto">
          <h1 class="text-light">SENSITY</h1>
          <!-- Uncomment below if you prefer to use an image logo -->
          <!-- <a href="index.html"><img src="assets/img/logo.png" alt="" class="img-fluid"></a>-->
        </div>
      </div>
    </header>
    <!-- End Header -->
<!-- Add this inside the <body> tag, preferably near the form -->

    <!-- ======= Hero Section ======= -->
    <section id="hero" class="d-flex align-items-center">
      <div class="container">
        <div class="row">
          
            <div>
              <h1>Sensity - Hệ thống phát hiện DeepFake dựa trên 
                Deep Learning</h1>
              <h2>Vui lòng tải ảnh lên để hệ thống kiểm tra
              </h2>
              <form id="upload-form" enctype="multipart/form-data">
                <input type="file" name="file" id="file-input"  />
                <input type="submit" value="Upload" />
              </form>

              <button id="download-report" style="display: none">Download Report</button>

              <div id="loading-spinner"  class="spinner-border wait-items text-primary" role="status" >
            </div>

              <span role="status" id="loading-text" class="wait-items">Đang phân tích ảnh của bạn, vui lòng chờ nhé !</span>
            </div>
            </div>
          </div>
          <div
            class="banner-img"
          >
         <div id="draw-box-btns" style="display: none;"">
          <button id="set-box" style=" margin-bottom: 10px;">Set Box for a Person (in case over 2 faces)</button><br>
<button id="confirm-box" style=" margin-bottom: 30px;">Confirm Selection</button>
</div>
            <img
              src="assets/img/mainpage.jpg"
              alt=""
              id="image-output"
            />
            <p
              id="image-credits"
              style="font-size: 10px; text-align: end; margin-top: 5px"
            >
             
            </p>
            <div id="result-div" style="display: none; margin-top: 20px">
              <h1>Kết quả dự đoán</h1>
              <p id="output"></p><br>
              <p id="percent"></p>

            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- End Hero -->

    <main id="main">
   

      <!-- Vendor JS Files -->
      <script src="assets/vendor/jquery/jquery.min.js"></script>
      <script src="assets/vendor/jquery.easing/jquery.easing.min.js"></script>
      <script src="assets/vendor/owl.carousel/owl.carousel.min.js"></script>
      <script src="assets/vendor/venobox/venobox.min.js"></script>
      <script src="assets/vendor/aos/aos.js"></script>

      <!-- Template Main JS File -->
      <script src="assets/js/main.js"></script>
      <script
        src="https://unpkg.com/uppload@2.3.0/dist/browser.js"
        crossorigin="anonymous"
      ></script>
      <script>
        let isBoxConfirmed = false;
        let croppedFile = null;
      
        document.getElementById('file-input').addEventListener('change', function(event) {
          var file = event.target.files[0];
          if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
              document.getElementById('image-output').src = e.target.result; // Update the src attribute
              document.getElementById('draw-box-btns').style.display = 'block';
              isBoxConfirmed = false;
              croppedFile = null;
            };
            reader.readAsDataURL(file);
          }
        });
      
        var img = document.getElementById('image-output');
        var box = document.createElement('div');
        box.id = 'detect-box'; 
                box.style.position = 'absolute';
        box.style.border = '2px solid red';
        box.style.width = '150px';
        box.style.height = '150px';
        box.style.display = 'none';
        document.body.appendChild(box);
      
        var offsetX, offsetY, startX, startY;
        var isDragging = false;
      
        document.getElementById('set-box').addEventListener('click', function() {
          box.style.display = 'block';
          img.parentElement.style.position = 'relative';
          box.style.left = (img.offsetLeft + img.width / 2 - 75) + 'px';
          box.style.top = (img.offsetTop + img.height / 2 - 75) + 'px';
      
          box.addEventListener('mousedown', function(e) {
            isDragging = true;
            offsetX = e.clientX - box.offsetLeft;
            offsetY = e.clientY - box.offsetTop;
          });
      
          document.addEventListener('mousemove', function(e) {
            if (isDragging) {
              box.style.left = (e.clientX - offsetX) + 'px';
              box.style.top = (e.clientY - offsetY) + 'px';
            }
          });
      
          document.addEventListener('mouseup', function() {
            isDragging = false;
          });
      
          document.getElementById('confirm-box').style.display = 'block';
        });
      
        document.getElementById('confirm-box').addEventListener('click', function() {
          var boxX = box.offsetLeft - img.offsetLeft;
          var boxY = box.offsetTop - img.offsetTop;
      
          var canvas = document.createElement('canvas');
          canvas.width = 150;
          canvas.height = 150;
          var ctx = canvas.getContext('2d');
      
          var image = new Image();
          image.src = img.src;
          image.onload = function() {
            ctx.drawImage(image, boxX, boxY, 150, 150, 0, 0, 150, 150);
            canvas.toBlob(function(blob) {
              croppedFile = new File([blob], 'cropped_image.jpg', { type: 'image/jpeg' });
              isBoxConfirmed = true;
              console.log('Cropped image prepared:', croppedFile);
            }, 'image/jpeg');
          };
          alert('Đã crop phần ảnh trong hình vuông, hãy upload để phát hiện deepfake trong khu vực đó ')
        
        });
      

        document.getElementById('upload-form').addEventListener('submit', function(event) {
          event.preventDefault();
          var formData = new FormData();
          var fileInput = document.getElementById('file-input');
      
          if (isBoxConfirmed && croppedFile) {
            formData.append('file', croppedFile);
            uploadEndpoint = '/upload_with_box';
          } else {
            formData.append('file', fileInput.files[0]);
            uploadEndpoint = '/';
          }
      
          // Show the spinner
          document.getElementById('loading-spinner').style.display = 'block';
          document.getElementById('loading-text').style.display = 'block';
      
          fetch(uploadEndpoint, {
            method: 'POST',
            body: formData
          })
          .then(response => {
            if (!response.ok) {
              if (response.status === 413) {
                throw new Error('Kích thước file quá lớn, vui lòng upload file nhỏ hơn 5MB');
              }
              else if(response.status === 415){
                throw new Error('Định dạng file không được hỗ trợ, vui lòng upload file jpg/png/jpeg');
              }
              else {
                throw new Error('An error occurred while uploading the file');
              }
            }
            return response.json();
          })
          .then(data => {
            if (data.file_url) {
              console.log('Uploaded image metadata:', data);
              document.getElementById('image-output').src = data.file_url; // Update the src attribute
              if(data.label.includes("real")) {
                document.getElementById('output').textContent = "Ảnh thật";
              } else {
                document.getElementById('output').textContent = "Ảnh fake";
              }
              document.getElementById('percent').textContent = "Xác suất: "+ data.percent+" %";
      
              document.getElementById('result-div').style.display = 'block';
              document.getElementById('download-report').style.display = 'block';
              document.getElementById('download-report').onclick = async function () {
                const reportResponse = await fetch('/download_report', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify(data),
                });
                const blob = await reportResponse.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style = 'none';
                a.href = url;
                a.download = 'report.pdf';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
              };
              document.getElementById('detect-box').style.display = 'none';

            } else {
              alert('File upload failed');
            }
          })
          .catch(error => {
            alert(error)
          })
          .finally(() => {
            // Hide the spinner
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('loading-text').style.display = 'none';
          });
        });
      </script>
    </strong>
    <nav class="mobile-nav d-lg-none">
      <ul>
        <li class="active"><a href="#header">Home</a></li>
        <li><a href="#results">Samples</a></li>
        <li><a href="#details">Details</a></li>
      </ul>
    </nav>
    <div class="mobile-nav-overly"></div>
    <div class="uppload-container">
      <div class="uppload-modal">
        <aside style="display: none" class="uppload-services--single">
          <nav class="uppload-services">
            <div data-uppload-service="local" class="uppload-service-name">
              <input
                type="radio"
                id="uppload-service-radio-local"
                value="local"
                name="uppload-radio"
              />
              <label
                for="uppload-service-radio-local"
                data-uppload-service="local"
              >
                <svg
                  aria-hidden="true"
                  viewBox="0 0 256 256"
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <g fill="#34495e" fill-rule="nonzero">
                    <path d="M177 56L125 4l-3-2v57h57c0-2-1-3-2-3z"></path>
                    <path
                      d="M173 113h8V75h-66c-5 0-8-4-8-8V1H27c-4 0-8 4-8 8v184c0 4 4 8 8 8h65v-8c0-45 36-80 81-80z"
                    ></path>
                    <path
                      d="M173 128c-36 0-65 29-65 64s29 64 65 64c35 0 64-29 64-64s-29-64-64-64zm27 63h-14v33c0 2-2 3-4 3h-20c-2 0-3-1-3-3v-33h-14c-3 0-5-3-3-5l28-30c1-2 3-2 5 0l27 30c2 2 1 5-2 5z"
                    ></path>
                  </g>
                </svg>
                <span>Choose file</span>
              </label>
            </div>
          </nav>
        </aside>
      
     <!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="errorModalLabel">Error</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p id="errorMessage"></p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>
  </body>
</html>